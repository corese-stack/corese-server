#
# Query definitions for a SPARQL tutorial based on a transformation
# To be used with /tutorial/rdf?profile=st:web
#
# Olivier Corby - Wimmics Inria I3S - 2017
#


  
us:hal a sw:Workflow ;

sw:display true;
sw:debug true;
sw:collect true;

sw:body (

[ a sw:Query ;
st:name st:intro ;
rdfs:label "Introduction" ;

rdfs:comment """Choisissez une requête dans le sélecteur. 'Previous' et 'Next' permettent de naviguer dans les requêtes successives.
Une question est alors posée avec un canevas de réponse à compléter. En cliquant sur 'Solution', on obtient la réponse attendue, en cliquant sur 'Template', le canevas réapparaît. 'Submit' soumet la requête SPARQL au serveur. """@fr ;

rdfs:comment """Choose a query in the selector. 'Previous' and 'Next' enable user to navigate in queries. When a query is selected, a query pattern is shown in the text area. 'Solution' displays the solution, 'Template' displays the query template. 'Submit' submits the SPARQL query to the server."""@en ;

st:query ""
]







[ a sw:Query ;
st:name st:member ;
rdfs:label "SPARKS Member" ;
rdfs:comment "SPARKS."@fr ;
rdfs:comment "Members of SPARKS"@en ;

st:query 
"""prefix skos: <http://www.w3.org/2004/02/skos/core#>
prefix org: <http://www.w3.org/ns/org#>
prefix hsc: <http://data.archives-ouvertes.fr/schema/>
@federate <https://data.archives-ouvertes.fr/sparql>
construct  {
    ?x skos:altLabel "SPARKS" .
    ?p hsc:structure ?x .
    ?p foaf:name ?n
}
where {
    ?x skos:altLabel "SPARKS" .
    ?s hsc:structure ?x .
    ?s hsc:person ?p .
    ?p foaf:name ?n
}
""" 
]






[ a sw:Query ;
st:name st:coauthorsparks ;
rdfs:label "SPARKS Coauthor" ;
rdfs:comment "SPARKS Coauthor."@fr ;
rdfs:comment "SPARKS Coauthor"@en ;

st:query 
"""prefix skos: <http://www.w3.org/2004/02/skos/core#>
prefix org: <http://www.w3.org/ns/org#>
prefix hsc: <http://data.archives-ouvertes.fr/schema/>
prefix dc:  <http://purl.org/dc/terms/>
prefix de:  <http://purl.org/dc/elements/1.1/> 
construct {
    ?n dc:coauthor ?n2
}
where {
service <https://data.archives-ouvertes.fr/sparql> {
select distinct ?n ?n2 where {
    ?x skos:altLabel ?l
    filter (?l in ("SPARKS", "WIMMICS")) .

    ?s hsc:structure ?x .
    ?s hsc:person ?p .
    ?p foaf:name ?n

    ?s2 hsc:structure ?x .
    ?s2 hsc:person ?p2 .
    ?p2 foaf:name ?n2

    filter (?n != ?n2)

    ?doc dc:creator ?s
    ?doc dc:creator ?s2
    #?doc de:subject ?topic
    ?doc dc:title ?title
}
}
}

""" 
]



[ a sw:Query ;
st:name st:topicsparks ;
rdfs:label "SPARKS Topic" ;
rdfs:comment "SPARKS Topic."@fr ;
rdfs:comment "Members of SPARKS and Wimmics linked by topics"@en ;

st:query 
"""prefix skos: <http://www.w3.org/2004/02/skos/core#>
prefix org: <http://www.w3.org/ns/org#>
prefix hsc: <http://data.archives-ouvertes.fr/schema/>
prefix dc:  <http://purl.org/dc/terms/>
prefix de:  <http://purl.org/dc/elements/1.1/> 
prefix fab: <http://purl.org/spar/fabio/>
construct {
    ?n us:interestedIn ?topic 
}
where {
service <https://data.archives-ouvertes.fr/sparql> {
    select distinct ?n ?topic where {
    ?x skos:altLabel ?l
        filter (?l in ("SPARKS", "WIMMICS")) .

        ?s hsc:structure ?x .
        ?s hsc:person ?p .
        ?p foaf:name ?n
    
        ?doc1 dc:creator ?s
        ?doc1 de:subject ?topic 
        filter langMatches(lang(?topic), "en")
    }
}
    bind (st:cset(st:group, ?n, st:other) as ?tmp)
}
""" 
]



[ a sw:Query ;
st:name st:topici3s ;
rdfs:label "I3S Topic" ;
rdfs:comment "I3S Topic."@fr ;
rdfs:comment "Members of I3S linked by topics"@en ;

st:query 
"""prefix skos: <http://www.w3.org/2004/02/skos/core#>
prefix org: <http://www.w3.org/ns/org#>
prefix hsc: <http://data.archives-ouvertes.fr/schema/>
prefix dc:  <http://purl.org/dc/terms/>
prefix de:  <http://purl.org/dc/elements/1.1/> 
construct {
    ?n us:interestedIn ?topic 
    ?n us:memberOf ?name
}
where {
service <https://data.archives-ouvertes.fr/sparql> {
    select distinct ?n ?topic ?name where {
    ?sam skos:altLabel "I3S"
    ?x org:unitOf ?sam ; skos:altLabel ?name

    ?s hsc:structure ?x .
    ?s hsc:person ?p .
    ?p foaf:name ?n

    ?doc1 dc:creator ?s
    ?doc1 de:subject ?topic 
    filter langMatches(lang(?topic), "en")
    #filter regex(?topic, "Intelligence")
}
}
    bind (st:cset(st:group, ?n, st:other) as ?tmp)
    bind (st:cset(st:group, ?topic, st:other) as ?tmp2)

}
""" 
]




[ a sw:Query ;
st:name st:topicsam ;
rdfs:label "Inria Topic" ;
rdfs:comment "Inria Topic."@fr ;
rdfs:comment "Members of Inria Sophia Antipolis linked by topics"@en ;

st:query 
"""prefix skos: <http://www.w3.org/2004/02/skos/core#>
prefix org: <http://www.w3.org/ns/org#>
prefix hsc: <http://data.archives-ouvertes.fr/schema/>
prefix dc:  <http://purl.org/dc/terms/>
prefix de:  <http://purl.org/dc/elements/1.1/> 
construct {
    ?n us:interestedIn ?topic 
    ?n us:memberOf ?name
}
where {
service <https://data.archives-ouvertes.fr/sparql> {
    select distinct ?n ?topic ?name where {
    ?sam skos:altLabel "CRISAM"
    ?x org:unitOf ?sam ; skos:altLabel ?name

    ?s hsc:structure ?x .
    ?s hsc:person ?p .
    ?p foaf:name ?n

    ?doc1 dc:creator ?s
    ?doc1 de:subject ?topic 
    filter regex(?topic, "Intelligence")
}}
    bind (st:cset(st:group, ?n, st:other) as ?tmp)
    bind (st:cset(st:group, ?topic, st:other) as ?tmp2)

}
""" 
]


[ a sw:Query ;
st:name st:confsam ;
rdfs:label "Inria Conf" ;
rdfs:comment "Inria Conf."@fr ;
rdfs:comment "Members of Inria Sophia Antipolis publishing in AI conference"@en ;

st:query 
"""prefix skos: <http://www.w3.org/2004/02/skos/core#>
prefix org: <http://www.w3.org/ns/org#>
prefix hsc: <http://data.archives-ouvertes.fr/schema/>
prefix dc:  <http://purl.org/dc/terms/>
prefix de:  <http://purl.org/dc/elements/1.1/> 
construct {
    #?u1 us:interestedIn ?source 
    ?n us:memberOf ?name
}
where {
service <https://data.archives-ouvertes.fr/sparql> {
    select distinct ?n ?name where {
    ?sam skos:altLabel "CRISAM"
    ?x org:unitOf ?sam ; skos:altLabel ?name

    ?s hsc:structure ?x .
    ?s hsc:person ?p .
    ?p foaf:name ?n

    ?doc1 dc:creator ?s
    ?doc1 dc:source ?source 
    filter regex(?source, "Artificial Intelligence")
}}
    bind (st:cset(st:group, ?n, st:other) as ?tmp)
}
""" 
]







[ a sw:Query ;
st:name st:unitof ;
rdfs:label "Unit of Lab" ;
rdfs:comment "Unit of Lab."@fr ;
rdfs:comment "Unit of Lab"@en ;

st:query 
"""prefix skos: <http://www.w3.org/2004/02/skos/core#>
prefix org: <http://www.w3.org/ns/org#>
prefix hsc: <http://data.archives-ouvertes.fr/schema/>
prefix dc:  <http://purl.org/dc/terms/>
prefix de:  <http://purl.org/dc/elements/1.1/> 
@federate <https://data.archives-ouvertes.fr/sparql>
construct {
    ?x skos:altLabel ?name
    ?x org:unitOf "Inria"
}
where {
    ?sam skos:altLabel "Inria"
    ?x org:unitOf ?sam ; skos:altLabel ?name
}

""" 
]



[ a sw:Query ;
st:name st:memberlab ;
rdfs:label "Member  Lab" ;
rdfs:comment "Member Lab."@fr ;
rdfs:comment "Member Lab"@en ;

st:query 
"""prefix skos: <http://www.w3.org/2004/02/skos/core#>
prefix org: <http://www.w3.org/ns/org#>
prefix hsc: <http://data.archives-ouvertes.fr/schema/>
prefix dc:  <http://purl.org/dc/terms/>
prefix org: <http://www.w3.org/ns/org#>
prefix lab: <http://www.unice.fr/other/>
prefix inr: <http://ns.inria.fr/sparql-extension/user/>
@federate <https://data.archives-ouvertes.fr/sparql>
construct {
    ?u1 us:memberOf ?name
}
where {
    ?p foaf:name ?n ; a foaf:Person
    filter regex(?n, "Olivier Corby")
    ?s hsc:person ?p .
    ?s hsc:structure ?lab .    
    ?lab skos:altLabel ?name
 
    bind (uri(concat(str(inr:), ?n))  as ?u1)
}
""" 
]


[ a sw:Query ;
st:name st:coauthorinria ;
rdfs:label "INRIA Coauthor" ;
rdfs:comment "INRIA Coauthor."@fr ;
rdfs:comment "INRIA Sophia coauthors, member of the same team"@en ;

st:query 
"""prefix skos: <http://www.w3.org/2004/02/skos/core#>
prefix org: <http://www.w3.org/ns/org#>
prefix hsc: <http://data.archives-ouvertes.fr/schema/>
prefix dc:  <http://purl.org/dc/terms/>
prefix org: <http://www.w3.org/ns/org#>
construct {
    ?n dc:coauthor ?n2
    ?n us:memberOf ?name
    ?n2 us:memberOf ?name
}
where {
service <https://data.archives-ouvertes.fr/sparql> {
select distinct ?n ?n2 ?name where {
    ?sam skos:altLabel "CRISAM"
    ?x org:unitOf ?sam ; skos:altLabel ?name

    ?s hsc:structure ?x .
    ?s hsc:person ?p .
    ?p foaf:name ?n

    ?s2 hsc:structure ?x .
    ?s2 hsc:person ?p2 .
    ?p2 foaf:name ?n2

    filter (?n < ?n2)

    ?doc dc:creator ?s
    ?doc dc:creator ?s2
    ?doc dc:issued ?date 
    filter (?date >= "2015-01-01"^^xsd:date && ?date <= "2016-12-31"^^xsd:date)
}
}
    bind (st:cset(st:group, ?n, st:other) as ?tmp) 
    bind (st:cset(st:group, ?n2, st:other) as ?tmp2) 

}
""" 
]



[ a sw:Query ;
st:name st:coauthorinrialab ;
rdfs:label "INRIA Coauthor with other Lab" ;
rdfs:comment "INRIA Coauthor with other Lab."@fr ;
rdfs:comment "INRIA Coauthor with other Lab"@en ;

st:query 
"""prefix skos: <http://www.w3.org/2004/02/skos/core#>
prefix org: <http://www.w3.org/ns/org#>
prefix hsc: <http://data.archives-ouvertes.fr/schema/>
prefix dc:  <http://purl.org/dc/terms/>
prefix org: <http://www.w3.org/ns/org#>
prefix lab: <http://www.unice.fr/other/>
prefix inr: <http://ns.inria.fr/sparql-extension/user/>
construct {
    ?n  dc:coauthor ?n2
    ?n  us:memberOf ?name 
    ?n2 us:memberOf ?ll
}
where {
service <https://data.archives-ouvertes.fr/sparql> {
select distinct ?n ?n2 ?name ?ll where {
    ?sam skos:altLabel "CRISAM"
    ?x org:unitOf ?sam ; skos:altLabel ?name
    ?s hsc:structure ?x .
    
    ?doc dc:creator ?s .
    ?doc dc:creator ?s2 .    
    filter (?s != ?s2)
    ?doc dc:issued ?date 
    filter (?date >= "2015-01-01"^^xsd:date)
   
    ?s2 hsc:structure ?y 
    ?y org:unitOf* ?z
    ?z skos:altLabel ?l 
    filter regex(?l, "I3S")
    ?y skos:altLabel ?ll 

    ?s hsc:person ?p .
    ?p foaf:name ?n .
    ?s2 hsc:person ?p2 .
    ?p2 foaf:name ?n2
    filter (?n != ?n2)
}
}
    bind (st:cset(st:group, ?n2, st:other) as ?tmp) 
    bind (st:cset(st:group, ?ll, st:other) as ?tmp2) 
}
""" 
]



[ a sw:Query ;
st:name st:coauthorinriacountry ;
rdfs:label "INRIA Coauthor with country" ;
rdfs:comment "INRIA Coauthor with country."@fr ;
rdfs:comment "INRIA Coauthor with country"@en ;

st:query 
"""prefix skos: <http://www.w3.org/2004/02/skos/core#>
prefix org: <http://www.w3.org/ns/org#>
prefix hsc: <http://data.archives-ouvertes.fr/schema/>
prefix dc:  <http://purl.org/dc/terms/>
prefix org: <http://www.w3.org/ns/org#>
prefix lab: <http://www.unice.fr/other/>
prefix inr: <http://ns.inria.fr/sparql-extension/user/>
prefix vs:  <http://www.w3.org/2006/vcard/ns#>
prefix db: <http://fr.dbpedia.org/resource/>
construct {
    ?n us:cooperate ?n2
    ?n2 org:unitOf ?yy
    ?yy skos:altLabel ?lyy
}
where {
service <https://data.archives-ouvertes.fr/sparql> {
    ?sam skos:altLabel "CRISAM"
    ?x org:unitOf ?sam ; skos:altLabel ?n
    ?s hsc:structure ?x .
    
    ?doc dc:creator ?s .
    ?doc dc:creator ?s2 .    
    filter (?s != ?s2)
   
    ?s2 hsc:structure ?y 
    ?y vs:country-name db:Italie, ?country    
    ?y skos:prefLabel ?n2
}
bind (st:cset(st:group, ?n2, st:other) as ?tmp)
}
""" 
]


[ a sw:Query ;
st:name st:coauthorcountry ;
rdfs:label "Coauthor with countries" ;
rdfs:comment "Coauthor with countries."@fr ;
rdfs:comment "Coauthor with countries"@en ;

st:query 
"""prefix skos: <http://www.w3.org/2004/02/skos/core#>
prefix org: <http://www.w3.org/ns/org#>
prefix hsc: <http://data.archives-ouvertes.fr/schema/>
prefix dc:  <http://purl.org/dc/terms/>
prefix org: <http://www.w3.org/ns/org#>
prefix lab: <http://www.unice.fr/other/>
prefix inr: <http://ns.inria.fr/sparql-extension/user/>
prefix vs:  <http://www.w3.org/2006/vcard/ns#>
prefix db:  <http://fr.dbpedia.org/resource/>
prefix geo: <http://www.w3.org/2003/01/geo/wgs84_pos#>
@event
construct {
    ?n us:cooperate ?country   
    ?country rdfs:label ?name
}
where {
service <https://data.archives-ouvertes.fr/sparql> {
select distinct ?n ?country ?cc where {
    ?sam skos:altLabel "I3S"
    ?x org:unitOf ?sam ; skos:altLabel ?n
    ?s hsc:structure ?x .
    
    ?doc dc:creator ?s .
    ?doc dc:creator ?s2 .  
    ?doc dc:issued ?date 
    filter (?date >= "2015-01-01"^^xsd:date)
    filter (?s != ?s2)
   
    ?s2 hsc:structure ?y 
    ?y vs:country-name ?country  
    
    bind (uri(replace(str(?country), " ", "_")) as ?cc)    
}}

service <http://fr.dbpedia.org/sparql> {
    select * where {
        ?cc rdfs:label ?name 
        filter langMatches(lang(?name), "en")
        optional { ?cc geo:lat ?lat ; geo:long ?lon }
    } 
}

}

#
# Record country location in a list of (country lat lon)
# List of location can be retrieved with st:get(st:location)
#
@after
function us:after(?map) {
    let (?list = xt:list(), ?table = xt:map()) {
        for ((?country ?lat ?lon) in ?map) {
            if (! xt:member(?country, ?table) && bound(?lat)) {
                xt:add(?list, xt:list(?country, ?lat, ?lon)) ;
                xt:set(?table, ?country, ?country)
            }
        } ;
        st:set(st:location, ?list) ;
        xt:print('list', ?list)
    } 
}

""" 
]




[ a sw:Query ;
st:name st:memberinria ;
rdfs:label "INRIA Member" ;
rdfs:comment "INRIA Member."@fr ;
rdfs:comment "INRIA Sophia member of teams"@en ;

st:query 
"""prefix skos: <http://www.w3.org/2004/02/skos/core#>
prefix org: <http://www.w3.org/ns/org#>
prefix hsc: <http://data.archives-ouvertes.fr/schema/>
prefix dc:  <http://purl.org/dc/terms/>
prefix org: <http://www.w3.org/ns/org#>
construct {
    ?n us:memberOf ?name
}
where {
service <https://data.archives-ouvertes.fr/sparql> {
select distinct ?n ?name  where {
    ?sam skos:altLabel "CRISAM"
    ?x org:unitOf ?sam ; skos:altLabel ?name

    ?s hsc:structure ?x .
    ?s hsc:person ?p .
    ?p foaf:name ?n
}}
bind (st:cset(st:group, ?n, st:other) as ?tmp)
}
""" 
]


[ a sw:Query ;
st:name st:author ;
rdfs:label "Author" ;
rdfs:comment "Author."@fr ;
rdfs:comment "Author"@en ;

st:query 
"""prefix foaf: <http://xmlns.com/foaf/0.1/>
prefix dc:   <http://purl.org/dc/terms/>

@federate <https://data.archives-ouvertes.fr/sparql>

construct {
    ?x foaf:name ?n .
    ?x foaf:publications ?doc .
    ?doc dc:title ?t ; dc:issued ?d
}
where {
    ?x foaf:name ?n 
    filter regex(?n, "Olivier") 
    ?x foaf:publications ?doc .
    optional { ?doc dc:hasVersion [ dc:title ?t ; dc:issued ?d ] }
}
limit 100
""" 
]



[ a sw:Query ;
st:name st:coauthor ;
rdfs:label "Coauthors" ;
rdfs:comment "Coauteurs."@fr ;
rdfs:comment "Coauthors"@en ;

st:query 
"""prefix foaf: <http://xmlns.com/foaf/0.1/>
prefix dc:   <http://purl.org/dc/terms/>

@federate <https://data.archives-ouvertes.fr/sparql>

construct {
    ?x foaf:name ?n .
    ?x foaf:publications ?doc .
    ?y foaf:publications ?doc .
    ?y foaf:name ?name .
    ?doc dc:title ?t ; dc:issued ?d
}
where {
    ?x foaf:name ?n 
    filter regex(?n, "Olivier") 
    ?x foaf:publications ?doc .
    ?y foaf:publications ?doc .
    ?y foaf:name ?name 
    optional { ?doc dc:hasVersion [ dc:title ?t ; dc:issued ?d ] }
    filter (?x != ?y)
}
limit 100
""" 
]


)
.
